<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>모험단 서버별 캐릭터 검색 (이미지 포함)</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
    h1 { text-align: center; margin-bottom: 1rem; }
    .search { display: flex; gap: .5rem; margin-bottom: 1rem; }
    select, input { flex: 1; padding: .5rem; font-size: 1rem; }
    button { padding: .5rem 1rem; font-size: 1rem; }
    ul { 
      list-style: none; 
      padding: 0; 
      display: flex; 
      flex-wrap: wrap; 
      gap: 1rem;
      justify-content: center;
    }
    li { 
      width: 100px; 
      text-align: center; 
      background: #f2f2f2; 
      padding: .5rem; 
      border-radius: 6px; 
    }
    li img {
      width: 80px; 
      height: 80px; 
      object-fit: cover; 
      border-radius: 4px;
      margin-bottom: .5rem;
    }
    li div.name {
      font-weight: bold;
      font-size: 0.9rem;
      word-break: break-all;
    }
  </style>
</head>
<body>
  <h1>모험단 서버별 캐릭터 검색</h1>
  <div class="search">
    <select id="serverSelect">
      <option>불러오는 중…</option>
    </select>
    <input id="q" type="text" placeholder="캐릭터명 입력" value="슈벨름"/>
    <button id="btn">검색</button>
  </div>
  <ul id="results"></ul>

  <script>
    const API_KEY = 'j3Uxqo3JwNLUNnMzn7v93bXgDpnDB7Ct';  
    const PROXY   = 'https://api.allorigins.win/raw?url=';

    const serverSelect = document.getElementById('serverSelect');
    const input        = document.getElementById('q');
    const btn          = document.getElementById('btn');
    const resultsEl    = document.getElementById('results');

    // 1) 서버 목록 불러오기
    async function loadServers() {
      const apiUrl   = `https://api.neople.co.kr/df/servers?apikey=${API_KEY}`;
      const fetchUrl = PROXY + encodeURIComponent(apiUrl);
      try {
        const res  = await fetch(fetchUrl);
        const json = await res.json();
        const rows = json.rows || [];
        serverSelect.innerHTML = rows
          .map(r => `<option value="${r.serverId}">${r.serverName}</option>`)
          .join('');
      } catch (e) {
        console.error('서버 목록 로드 실패', e);
        serverSelect.innerHTML = '<option>로드 실패</option>';
      }
    }

    // 2) 선택된 서버 + 캐릭터명으로 검색 & 렌더링
    async function searchCharacters() {
      const server = serverSelect.value;
      const name   = input.value.trim();
      if (!name) {
        alert('캐릭터명을 입력하세요.');
        return;
      }

      resultsEl.innerHTML = '<li>검색 중…</li>';

      // characters API 호출
      const apiUrl =
        `https://api.neople.co.kr/df/servers/${server}/characters`
        + `?characterName=${encodeURIComponent(name)}`
        + `&wordType=match`
        + `&limit=10`
        + `&apikey=${API_KEY}`;
      const fetchUrl = PROXY + encodeURIComponent(apiUrl);

      try {
        const res  = await fetch(fetchUrl);
        const json = await res.json();
        const rows = json.rows || [];

        if (rows.length === 0) {
          resultsEl.innerHTML = '<li>검색 결과가 없습니다.</li>';
          return;
        }

        // 결과를 이미지 + 이름 형태로 렌더링
        resultsEl.innerHTML = rows.map(r => {
          // 이미지 URL: characterId 사용
          const imgUrl =
            `https://img-api.neople.co.kr/df/servers/${server}`
            + `/characters/${r.characterId}?zoom=1`;

          return `
            <li>
              <img src="${imgUrl}" alt="${r.characterName}" 
                   onerror="this.src='https://via.placeholder.com/80?text=No+Image'"/>
              <div class="name">${r.characterName}</div>
            </li>`;
        }).join('');
      } catch (e) {
        console.error('검색 실패', e);
        resultsEl.innerHTML = '<li>검색 중 오류가 발생했습니다.</li>';
      }
    }

    // 초기 로드
    loadServers();
    btn.addEventListener('click', searchCharacters);
  </script>
</body>
</html>
