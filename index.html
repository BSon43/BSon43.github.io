<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>모험단원 명성 검색</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
    .search { display: flex; gap: .5rem; margin-bottom: 1rem; }
    .search input { flex: 1; padding: .5rem; font-size: 1rem; }
    .search button { padding: .5rem 1rem; font-size: 1rem; }
    ul { list-style: none; padding: 0; }
    li { background: #f2f2f2; margin-bottom: .5rem; padding: .75rem; border-radius: 4px; }
    strong { display: inline-block; width: 140px; }
  </style>
</head>
<body>
  <h1>모험단원 명성 검색</h1>
  <div class="search">
    <input id="q" type="text" placeholder="모험단명 입력" value="슈벨름" />
    <button id="btn">검색</button>
  </div>
  <ul id="results"></ul>

  <script>
    // ✏️ 여기에만 API 키를 넣으세요
    const API_KEY = 'j3Uxqo3JwNLUNnMzn7v93bXgDpnDB7Ct';
    const SERVER  = 'all';  // 모험단 서버(ID)

    async function fetchGuildMembers(name) {
      // 1) 모험단 검색 → guildId 얻기
      const searchUrl =
        `https://api.neople.co.kr/df/servers/${SERVER}/guilds`
        + `?guildName=${encodeURIComponent(name)}`
        + `&wordType=match`   // 정확 일치 검색
        + `&limit=1`          // 첫 번째 결과만
        + `&apikey=${API_KEY}`;
      console.log('Guild search URL:', searchUrl);

      const res1  = await fetch(searchUrl);
      const json1 = await res1.json();
      const guild = (json1.rows || []).shift();
      if (!guild) return [];

      const guildId = guild.guildId;

      // 2) 해당 모험단원 목록 가져오기
      const membersUrl =
        `https://api.neople.co.kr/df/servers/${SERVER}/guilds/`
        + `${guildId}/members`
        + `?apikey=${API_KEY}`;
      console.log('Members URL:', membersUrl);

      const res2    = await fetch(membersUrl);
      const json2   = await res2.json();
      const members = json2.members || json2.rows || [];
      console.log('Members count:', members.length);

      // 3) 각 모험단원별로 status API 호출 → fame 얻기
      const result = await Promise.all(members.map(async m => {
        const statusUrl =
          `https://api.neople.co.kr/df/servers/${SERVER}/characters/`
          + `${m.characterId}/status`
          + `?apikey=${API_KEY}`;
        const res3  = await fetch(statusUrl);
        const json3 = await res3.json();
        const fame  = json3.characterStatus?.fame ?? '—';
        return { name: m.characterName, fame };
      }));

      return result;
    }

    document.getElementById('btn').onclick = async () => {
      const name = document.getElementById('q').value.trim();
      const ul   = document.getElementById('results');
      ul.innerHTML = '<li>로딩 중…</li>';

      try {
        const list = await fetchGuildMembers(name);
        if (list.length === 0) {
          ul.innerHTML = '<li>검색 결과가 없습니다.</li>';
        } else {
          ul.innerHTML = list
            .map(i => `<li><strong>${i.name}</strong> — 명성 ${i.fame}</li>`)
            .join('');
        }
      } catch (e) {
        console.error(e);
        ul.innerHTML = '<li>오류가 발생했습니다.</li>';
      }
    };
  </script>
</body>
</html>
